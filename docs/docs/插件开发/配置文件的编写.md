# 配置文件的编写

## 插件的配置文件

几乎大部分的插件都会用到配置文件，这里说一下配置文件如何去编写

首先在包内创建config.py，这里是用来编写配置模型以及配置文件的读取写入的地方

### 配置模型的创建

所有的配置模型都是基于pydantic库的，使用该库作为配置文件序列化和反序列化过程中数据类型的规范，详见[Nonebot2官方文档 - 插件配置](https://nonebot.dev/docs/appendices/config#%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE)

我们在config.py中创建一个配置模型，代码如下，在编写完该类之后，需要到`__init__.py`文件中的`__plugin_meta__`下添加`config=Config`字段(需要提前导入该类)

```python
# config.py

from pydantic import Field, BaseSettings

# 所有的配置项都由pydantic进行规范
class Config(BaseSettings):  # Config类继承基础设置类BaseSettings
    apscheduler_autostart: bool = True  # 一定设置默认值
    # 不设置默认值的时候类型标注请将int改为Optional[int]表示该项是可选的，Optional在typing库中导入
    apscheduler_log_level: int = 30
    apscheduler_config: dict = Field(  # Field类用于嵌套的情况
        default_factory=lambda: {"apscheduler.timezone": "Asia/Shanghai"}
    )

    class Config:
        extra = "ignore"

```

以上配置模型对应如下配置文件

```json5
// config.json

{
    "apscheduler_autostart": true,
    "apscheduler_log_level": 30,
    "apscheduler_config": {
        "apscheduler.timezone": "Asia/Shanghai"
    }
}

```

### 配置文件的存储

在这里我们不按照nonebot2文档的写法将所有的配置项都写入.env环境配置文件，而是将所有的配置项按照插件分开，全部存储于项目根目录下的configs目录下

#### 如何获取配置文件路径以及创建配置文件文件夹

项目中已经内涵一个插件位于`basic_plugins/localstore`下，这个插件用于为其他插件暴露出他们的数据、缓存以及配置文件应该存储的位置

导入这个插件的内容之前需要先进行require。require的作用为让nonebot在这个地方提前初始化require的插件内容，防止出现奇怪的错误

代码如下

```python
# config.py

# 顺序不可变
from nonebot import require
require("localstore")
from basic_plugins.localstore import get_config_file, get_config_dir

```

这样我们就获取到了这样一个函数用于获取插件的配置文件路径

然后键入如下内容

```python
# config.py

if not os.path.isfile(get_config_file("SentryLogWarning", "config.json")):
    os.makedirs(get_config_dir("SentryLogWarning"), exist_ok=True)
    with open(get_config_file("SentryLogWarning", "config.json"), "w") as f:
        f.write(Config().json(indent=4))
config = Config.parse_file(get_config_file("SentryLogWarning", "config.json"))

```

这样我们就能获取到该插件配置文件的内容，并且当这个文件不存在时会自动在configs目录下创建该插件的配置文件目录并写入默认配置文件内容

### 带配置文件的插件的最小实例

以下为一个config.py的最小实例

```python
# config.py

import os
from pydantic import Field, BaseSettings


class Config(BaseSettings):
    apscheduler_autostart: bool = True
    apscheduler_log_level: int = 30
    apscheduler_config: dict = Field(
        default_factory=lambda: {"apscheduler.timezone": "Asia/Shanghai"}
    )

    class Config:
        extra = "ignore"

plugin_config_dir = get_config_dir("APScheduler")  # 获取路径
plugin_config_file = get_config_file("APScheduler", "config.json")  # 获取路径
if not os.path.isfile(plugin_config_file):  # 检查目录并进行创建
    os.makedirs(plugin_config_dir, exist_ok=True)
    with open(plugin_config_file, "w") as f:
        f.write(Config().json(indent=4))

plugin_config = Config.parse_file(plugin_config_file)  # 读取配置文件，包内其他文件读取配置导入这个

```
